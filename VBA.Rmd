---
title: "VBA"
subtitle: "Estudo dirigido de Macro e VBA"
author: "Sergio Pedro R Oliveira"
date: "`r format(Sys.time(), '%d %B %Y')`"
#lof: true #adiciona lista de figuras
#lot: true #adiciona lista de tabelas
#toc-title: SUMÁRIO #nome do sumário
output:
  pdf_document:
    number_sections: yes
    toc: no
  html_document:
    toc: yes
    df_print: paged
  word_document:
    toc: yes
    number_sections: yes
  odt_document:
    number_sections: yes
bibliography: R_markdown/bibliografia_R.bib
csl: R_markdown/abnt.csl
---

\thispagestyle{empty}

\newpage
\pagenumbering{roman}

```{=latex}
\setcounter{tocdepth}{4}
\renewcommand{\contentsname}{SUMÁRIO}
\tableofcontents
```

\newpage

```{=latex}
\setcounter{tocdepth}{4}
\renewcommand{\listfigurename}{LISTA DE FIGURAS}
\listoffigures
```

\newpage

```{=latex}
\setcounter{tocdepth}{4}
\renewcommand{\listtablename}{LISTA DE TABELAS}
\listoftables
```

```{r Pacotes, message=FALSE, warning=FALSE, echo=FALSE}
library(knitr)
library(rmarkdown)
library(readr)
library(tibble)
library(magrittr)
library(dplyr)
library(tidyr)
library(data.table)
library(janitor)
```

\newpage

# OBJETIVO

Estudo dirigido Macro e **VBA** Excel.\

\pagenumbering{arabic}
\newpage

# MACROS

## Diferenças entre Macros e **VBA**\
- Macros:\
  - Script para automatização de tarefas.\
  - Gravar sequências de ações e transformar em um script ou comandos (macros).\
  - Não necessita de conhecimento de programação.\
- **VBA** (*Visual Basic for Application*):\
  - Linguagem de programação de script do Excel.\

## Habilitar opção desenvolvedor

Excel > Arquivo > Opções > Personalizar faixa de opções > (marcar opção) Desenvolvedor\


![Habilitar opção de Desenvolvedor.](Imagens\Macros\Habilitar_Desenvolvedor.png){}


\newpage

## Gravar Macro

- Três opções para abrir uma gravação de uma Macro:\
1. Primeira opção:\
Na aba Desenvolvedor, opção "Gravar macro".\

![Primeira opção para gravar macro.](Imagens\Macros\Gravar_macro_1.png){}


2. Segunda opção:\
Na aba Exibir, dentro da opção "Macros", tem a opção "Gravar macro".\

![Segunda opção para gravar macro.](Imagens\Macros\Gravar_macro_2.png){}


3. Terceira opção:\
No rodapé esquerdo tem um icone para gravar macro.\

![Terceira opção para gravar macro.](Imagens\Macros\Gravar_macro_3.png){}


\newpage

- Tela inicial de gravação de Macro:\
  - *Nome da macro*:\
    - Inserir o nome da Macro.\
    - Não aceita espaço, logo, ou colar o nome da macro tudo junto ("PrimeiraMacro"), ou usar o underline ("Primeira_Macro").\
  - *Tecla de atalho*:\
    - Podemos colocar um atalho para chamar a Macro.\
    - Caso o atalho já esteja em uso, o Excel sugere outro atalho, mas não deixa sobreescrever.\
  - *Armazenar macro em*:\
    - *Esta pasta de trabalho*\
    A Macro funcionará apenas para este arquivo.\
    - *Nova pasta de trabalho*\
    Cria a Macro em outra pastas.\
    - *Pasta de trabalho pessoal de macros*\
    É criado uma macro global que serve para todos as planilhas.\
  - *Descrição*:\
  Podemos inserir um texto que descreve o que a macro faz.\

![Tela inicial de gravação de macros.](Imagens\Macros\Gravar_macro_tela.png){}


\newpage

- Gravando Macro:\
  - Ao iniciar uma gravação de uma macro, o programa não pega a movimentação do mouse e nem o tempo.\
  - O programa pega apenas as tarefas aplicadas.\
- Encerrando gravação de uma Macro:\

![Encerrar gravação de Macro, primeira forma.](Imagens\Macros\Encerrar_Macro_1.png){}


![Encerrar gravação de Macros, segunda forma.](Imagens\Macros\Encerrar_Macro_2.png){}


\newpage

- Executando uma Macro:\
  - Usando o atalho de teclado sugerido.\
  Caso tenha esquecido qual o atalho do teclado para determinada Macro, na tela de edição da Macro (tela de *Visual Basic*), no script da Macro, fica comentado o atalho do teclado.\
  - Na aba "*Desenvolvedor*", na opção "*Macros*". Na tela de "*Macro*", selecionar a Macro desejada e apertar a opção "*Executar*".\
  ![Executar uma determinada Macro.](Imagens\Macros\Executar_Macro.png){}

\newpage

## Acessando Macros
- Para acessar as Macros criadas basta ir na aba "Desenvolvedor", ou na aba "Exibir", na opção "Macros".\
  
![Acessando a tela de Macros, opção 1 (aba "Desenvolvedor" > opção "Macros").](Imagens\Macros\Acessando_Macros_1.png){}


![Acessando a tela de Macros, opção 2 (aba "Exibir" > opção "Macros").](Imagens\Macros\Acessando_Macros_2.png){}


\newpage

- Para acessar o script gerado pela Macro e poder edita-lo, na tela de "*Macros*", selecionamos a Macro desejada e procuramos a opção "*Editar*". Assim somos enviados para tela do "*Visual Basic*".\
  
![Tela de Macros, opção *Editar*.](Imagens\Macros\Editar_Macro.png){width=60%}

  
![Tela de Visual Basic, para editar Macro.](Imagens\Macros\Tela_Visual_Basic.png){width=60%}

  
\newpage

## Salvando Arquivo com Macro

- O Excel por default não salva as Macros criadas em um arquivo Excel.\
- Quando o arquivo é salvo e fechado as Macros são apagadas.\
- Para salvar um arquivo com Macros é necessario:
  - ir em "*salvar como*".\
  - Definir o local de salvamento.\
  - Definir um nome para o arquivo.\
  - No tipo de arquivo, selecionar a opção:\
  "*Pasta de Trabalho Habilitada para Macro do Excel (\*.xlsm)*"\

![Salvando arquivo Excel com Macros.](Imagens\Macros\Salvando_macro.png){}


\newpage

## Noção básica do script das Macros

- Adicionar comentários:\
  - Para adionar comentários ao script usamos uma aspas simples, tudo que vier depois na linha é um comentário.\
  - Como boas práticas normalmente adicionamos:\
    - O nome da função (Macro). (Automático)\
    - Atalho no teclado para executar a Macro. (Automático)\
    - Data de criação.\
    - Quem criou a Macro e o seu contato.\
    - Breve descrição da Macro.\

- Seleção:\
  - Selecionar célula:\
  `Range("A1").Select`\
  - Selecionar coluna:\
  `Columns("A:A").Select`\
  - Selecionar linhas:\
  `Rows("1:3").Select`\

- Zoom:\
Determina o valor do zoom da janela do Excel.\
`ActiveWindow.Zoom = 100`\

- Inserir fórmula numa célula ativa (selecionada):\
  - Texto:\
  `ActiveCell.FormulaR1C1 = "Texto"`\
  - Fórmula:\
  `ActiveCell.FormulaR1C1 = "=SUM(4,5)"`\

\newpage

- Formatação básica:\
  - Itálico\
  `Selection.Font.Italic = True | False`\
  - Negrito\
  `Selection.Font.Bold = True | False`\
  - Alinhamentos:\
  Dentro das células selecionadas pelo comando `with`:\
  ```
  With Selection
    .Bloco de programação
  End With
  ```
    - Horzontal\
    `.HorizontalAlignment = xlRight | xlCenter | xlLeft`\
    - Vertical\
    `.VerticalAlignment = xlTop | xlCenter | xlBottom`\
  - Auto-ajuste coluna/linha (Automático)\
  `Columns("A:A").EntireColumn.AutoFit`\
  `Rows("1:1").EntireColumn.AutoFit`\

- Função (Macro):\
  - VBA é uma linguagem identada.\
  - A função Macro no VBA do Excel é uma função `Sub()`.\
  - Como o nome da Macro é o nome que encontramos na função `Sub()`, podemos mudar o nome da Macro alterando o nome na função `Sub()`.\
  Exemplo:\
  Mudando nome da Macro,\
  `Sub MinhaPrimeiraMacro()`\
  para,\
  `Sub Minha_Primeira_Macro()`\
  - Sintaxe:\
  ```
  Sub nome_da_macro(argumento_s_1, argumento_s_2, ...)
    Bloco de programação
  End Sub
  ```

\newpage

## Simplificando Macros

### Teoria de simplificação de Macros

- Podemos simplificar Macros ao abrir o script e cortar, ou juntar, trechos que são desnecessarios, ou redundantes. Deixando a Macro mais objetiva.\
- Exemplo de script simplificado:\

![Script original da Macro.](Imagens\Macros\Script_nao_simplificado.png){width=80%}


![Script simplificado da Macro.](Imagens\Macros\Script_simplificado.png){width=80%}


\newpage

### Técnicas para simplificar Macros

- Juntar seleção de célula e inserção de fórmula:\
  Ao inves de selecionar uma célula e inserir fórmala separadamente.\
  ```
  Range("A1").Select
  ActiveCell.FormulaR1C1 = "Sergio Pedro Rodrigues Oliveira"
  ```
  Podemos fazer as duas coisas de uma só vez.\
  `Range("A1").FormulaR1C1 = "Sergio Pedro Rodrigues Oliveira"`

- Eliminando comandos desnecessários da formatação básica:\
  Existem determinados comandos que são gerados automaticamente quando desejamos fazer formatação do alinhamento do texto numa célula, dentro do comando `with selection`, nem todos esses comandos são necessarios.\
  ```
  With Selection
    .HorizontalAlignment = xlGeneral
    .VerticalAlignment = xlCenter
    .WrapText = False
    .Orientation = 0
    .AddIndent = False
    .IndentLevel = 0
    .ShrinkToFit = False
    .ReadingOrder = xlContext
    .MergeCells = False
  End With
  With Selection
    .HorizontalAlignment = xlCenter
    .VerticalAlignment = xlCenter
    .WrapText = False
    .Orientation = 0
    .AddIndent = False
    .IndentLevel = 0
    .ShrinkToFit = False
    .ReadingOrder = xlContext
    .MergeCells = False
  End With
  ```
  Logo, podemos omiti-los para simplificar o script.\
  Também podemos juntar os comandos de formatação de alinhamento da mesma célula dentro de um mesmo comando `with selection`.\
  ```
  With Selection
    .HorizontalAlignment = xlCenter
    .VerticalAlignment = xlBottom
  End With
  ```

\newpage

- Zoom simplificado:\
  Ao invés de passar de valor de zoom por valor de zoom.\
  ```
  ActiveWindow.Zoom = 110
  ActiveWindow.Zoom = 120
  ActiveWindow.Zoom = 130
  ActiveWindow.Zoom = 140
  ActiveWindow.Zoom = 150
  ```
  Podemos ir direto no valor de zoom desejado, eliminando assim as transições.\
  `ActiveWindow.Zoom = 150`\

\newpage

## Referência Relativa (ou Macro Relativa)

### Referência Relativa

- Quando ativado a opção "Usar referência relativa", na aba "Desenvolvedor", aplica a Macro onde o cursor esta ativo, ou usa o curso como referência.\
- Ex.: Se você gravar na célula A1 uma Macro que move o cursor para A3, com a opção "Usar referência relativa" ativada, a execução da Macro resultante na célula J6 moverá o cursor para J8.\

### Referência Absoluta

- A forma tradicional com a opção "Usar referência relativa" desativada, é chamado de referência absoluta, onde a Macro apenas repete os comandos nas células|colunas|linhas selecionadas previamente estabelecidas.\
- Ex.: Se você gravar na célula A1 uma Macro que move o cursor para A3, com a opção "Usar referência relativa" desativada, a execução da Macro resultante na célula J6 moverá o cursor para A3.\

### Usando referências relativa e absoluta

- Podemos usar as duas opções de referência durante a gravação de uma Macro, basta ativar e desativar a opção "Usar referência relativa" durante o processo de gravação.\
